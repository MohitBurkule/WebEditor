<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced Monaco Editor + transformers.js + GitHub + Cookie Manager</title>
  
  <!-- Monaco Editor CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs/editor/editor.main.min.css" />
  <!-- Iconify for icons -->
  <script src="https://code.iconify.design/2/2.2.1/iconify.min.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background: #f3f3f3;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: #1e1e1e;
      color: #ccc;
    }
    /* Toolbar */
    #toolbar {
      display: flex;
      align-items: center;
      padding: 8px;
      background: #007acc;
      color: white;
      flex-wrap: wrap;
    }
    #toolbar button, #toolbar label, #toolbar select {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 16px;
      margin: 4px;
      cursor: pointer;
    }
    /* Tabs */
    #tabs {
      display: flex;
      background: #eee;
      border-bottom: 1px solid #ccc;
    }
    #tabs button {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #tabs button.active {
      background: #ddd;
      font-weight: bold;
    }
    /* Main container (Editor + Preview) */
    #mainContainer {
      display: flex;
      width: 100%;
      height: calc(100% - 140px); /* toolbar + tabs height */
    }
    /* Editor container */
    #editorContainer {
      width: 50%;
      min-width: 200px;
      height: 100%;
      position: relative;
    }
    /* Resizer for editor/preview */
    #resizer {
      width: 5px;
      background: #ccc;
      cursor: col-resize;
      z-index: 2;
    }
    /* Preview container */
    #previewContainer {
      flex: 1;
      background: #fff;
      position: relative;
      overflow: hidden;
      transition: width 0.3s;
    }
    /* Mobile view styles */
    #previewContainer.mobile-view {
      width: auto;
      max-width: 100%;
      margin: 0 auto;
      border: 1px solid #aaa;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #livePreview {
      width: 100%;
      height: 100%;
      border: none;
    }
    /* Console Panel */
    #consolePanel {
      background: #333;
      color: #fff;
      padding: 10px;
      font-family: monospace;
      height: 200px;
      overflow-y: auto;
      display: none;
      resize: vertical;
    }
    /* Console resizer */
    #consoleResizer {
      height: 5px;
      background: #555;
      cursor: ns-resize;
    }
    /* Cookie Modal */
    #cookieModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    #cookieModal .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      border-radius: 4px;
    }
    #cookieModal textarea {
      width: 100%;
      height: 200px;
    }
    #cookieModal button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div id="toolbar">
    <button id="aiAssist" title="AI Assist" disabled>
      <span class="iconify" data-icon="mdi:lightbulb-on-outline"></span> AI Assist
    </button>
    <button id="aiDebug" title="AI Debug" disabled>
      <span class="iconify" data-icon="mdi:bug"></span> AI Debug
    </button>
    <button id="toggleTheme" title="Toggle Dark/Light Mode">
      <span class="iconify" data-icon="mdi:theme-light-dark"></span> Toggle Theme
    </button>
    <button id="runCode" title="Run Code">
      <span class="iconify" data-icon="mdi:play"></span> Run Code
    </button>
    <label>
      <input type="checkbox" id="autoRunCheckbox" checked /> Auto-run?
    </label>
    <button id="undo" title="Undo">
      <span class="iconify" data-icon="mdi:undo"></span> Undo
    </button>
    <button id="redo" title="Redo">
      <span class="iconify" data-icon="mdi:redo"></span> Redo
    </button>
    <button id="githubSync" title="GitHub Sync">
      <span class="iconify" data-icon="mdi:github"></span> GitHub Sync
    </button>
    <button id="exportProject" title="Export Project">
      <span class="iconify" data-icon="mdi:download"></span> Export
    </button>
    <button id="manageCookies" title="Manage Cookies">
      <span class="iconify" data-icon="mdi:cookie"></span> Cookies
    </button>
    <button id="toggleConsole" title="Toggle Console">
      <span class="iconify" data-icon="mdi:console-line"></span> Console
    </button>
    <button id="toggleMobile" title="Toggle Mobile View">
      <span class="iconify" data-icon="mdi:cellphone"></span> Mobile Preview
    </button>
    <!-- Device Size Selector (for mobile preview) -->
    <label>
      Screen Size:
      <select id="deviceSize">
        <option value="320">320px</option>
        <option value="375" selected>375px</option>
        <option value="414">414px</option>
        <option value="768">768px</option>
        <option value="1024">1024px</option>
      </select>
    </label>
  </div>

  <!-- Tabs -->
  <div id="tabs">
    <button class="tab active" data-lang="html">
      <span class="iconify" data-icon="mdi:file-code"></span> HTML
    </button>
    <button class="tab" data-lang="css">
      <span class="iconify" data-icon="mdi:file-code"></span> CSS
    </button>
    <button class="tab" data-lang="js">
      <span class="iconify" data-icon="mdi:file-code"></span> JavaScript
    </button>
  </div>

  <!-- Main container: Editor + Resizer + Preview -->
  <div id="mainContainer">
    <div id="editorContainer"></div>
    <div id="resizer"></div>
    <div id="previewContainer">
      <iframe id="livePreview"></iframe>
    </div>
  </div>

  <!-- Console Panel with Resizer -->
  <div id="consoleResizer"></div>
  <div id="consolePanel">
    <strong>Console Output:</strong>
    <div id="consoleOutput"></div>
  </div>

  <!-- Cookie Modal -->
  <div id="cookieModal">
    <div class="modal-content">
      <h3>Manage Cookies</h3>
      <textarea id="cookieText"></textarea>
      <br />
      <button id="saveCookies">Save Changes</button>
      <button id="clearAllCookies">Clear All Cookies</button>
      <button id="closeCookieModal">Close</button>
    </div>
  </div>

  <!-- Load transformers.js via dynamic import in our main code -->
  <script>
    // Dynamically import transformers.js and assign it to window.transformers.
    async function loadTransformersModule() {
      try {
        const transformers = await import('https://unpkg.com/@xenova/transformers/dist/transformers.js');
        window.transformers = transformers;
        console.log("Transformers module loaded.");
      } catch (e) {
        console.error("Error importing transformers.js:", e);
      }
    }
    loadTransformersModule();
  </script>

  <!-- Temporarily disable AMD for HTMLHint -->
  <script>
    var backupDefine = window.define;
    var backupRequire = window.require;
    window.define = undefined;
    window.require = undefined;
  </script>
  <!-- Load HTMLHint -->
  <script src="https://cdn.jsdelivr.net/npm/htmlhint@1.1.4/dist/htmlhint.min.js"></script>
  <script>
    if (typeof HTMLHint === "undefined") window.HTMLHint = {};
    if (typeof HTMLHint.verify !== "function") {
      HTMLHint.verify = function() { return []; };
    }
    window.define = backupDefine;
    window.require = backupRequire;
  </script>

  <!-- Monaco AMD Loader (only once) -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs/loader.js"></script>
  <!-- JSZip for exporting project -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    /************************************************************
     * Main Code:
     *  - Setup Monaco Editor with persistent models.
     *  - Dynamically load transformers.js and then load the model.
     *  - Setup AI Assist/Debug, GitHub sync, run/auto-run, theme toggle,
     *    cookie modal, console panel (with resizer), and mobile preview (with device sizes).
     ************************************************************/
    
    let textGenPipeline = null;
    let modelLoaded = false;
    
    // Load the model asynchronously once transformers.js is available.
    async function loadModel() {
      // Wait until window.transformers is defined
      while (!window.transformers) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      console.log("Loading transformers.js model...");
      try {
        // You can change the model name if you want a code-specific one.
        textGenPipeline = await window.transformers.pipeline("text-generation", "Xenova/gpt2");
        modelLoaded = true;
        console.log("Model loaded successfully.");
        document.getElementById("aiAssist").disabled = false;
        document.getElementById("aiDebug").disabled = false;
      } catch (err) {
        console.error("Error loading model:", err);
      }
    }
    loadModel();

    require.config({
      paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs" }
    });

    require(["vs/editor/editor.main"], function () {
      /********** DEFAULT CODE PER LANGUAGE **********/
      const defaultContent = {
        html: "<!DOCTYPE html>\n<html>\n<head>\n  <title>Live Preview</title>\n</head>\n<body>\n  <h1>Hello World</h1>\n</body>\n</html>",
        css:  "body { font-family: sans-serif; padding: 20px; }",
        js:   "console.log('Hello, JavaScript!');"
      };

      /********** CREATE MONACO MODELS (Persistent) **********/
      const models = {
        html: monaco.editor.createModel(defaultContent.html, "html"),
        css:  monaco.editor.createModel(defaultContent.css,  "css"),
        js:   monaco.editor.createModel(defaultContent.js,   "javascript")
      };

      let currentLang = "html";
      let editor = null;

      /********** CREATE/SHOW EDITOR **********/
      function createEditorForLang(lang) {
        editor = monaco.editor.create(document.getElementById("editorContainer"), {
          model: models[lang],
          theme: document.body.classList.contains("dark-mode") ? "vs-dark" : "vs-light",
          automaticLayout: true
        });
        editor.onDidChangeModelContent(() => {
          if (document.getElementById("autoRunCheckbox").checked) {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(updatePreview, 500);
          }
          clearTimeout(lintTimeout);
          lintTimeout = setTimeout(runLinting, 1000);
        });
      }

      // Initialize editor with HTML
      createEditorForLang(currentLang);

      /********** TAB SWITCHING **********/
      document.querySelectorAll(".tab").forEach((tabBtn) => {
        tabBtn.addEventListener("click", () => {
          const lang = tabBtn.getAttribute("data-lang");
          if (lang === currentLang) return;
          if (editor) editor.dispose();
          document.querySelectorAll(".tab").forEach((btn) => btn.classList.remove("active"));
          tabBtn.classList.add("active");
          currentLang = lang;
          createEditorForLang(lang);
        });
      });

      /********** RUN CODE BUTTON **********/
      const runBtn = document.getElementById("runCode");
      const autoRunCheckbox = document.getElementById("autoRunCheckbox");
      runBtn.addEventListener("click", () => {
        updatePreview();
      });

      /********** LIVE PREVIEW **********/
      let previewTimeout;
      function updatePreview() {
        const htmlCode = models.html.getValue();
        const cssCode  = models.css.getValue();
        const jsCode   = models.js.getValue();

        const previewFrame = document.getElementById("livePreview");
        const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        previewDoc.open();
        previewDoc.write(
          htmlCode + "<style>" + cssCode + "</style>" + "<script>" + jsCode + "<\/script>"
        );
        previewDoc.close();
      }

      /********** UNDO / REDO **********/
      document.getElementById("undo").addEventListener("click", () => {
        if (editor) editor.trigger("keyboard", "undo", null);
      });
      document.getElementById("redo").addEventListener("click", () => {
        if (editor) editor.trigger("keyboard", "redo", null);
      });

      /********** THEME TOGGLE **********/
      let isDarkMode = false;
      document.getElementById("toggleTheme").addEventListener("click", () => {
        isDarkMode = !isDarkMode;
        monaco.editor.setTheme(isDarkMode ? "vs-dark" : "vs-light");
        document.body.classList.toggle("dark-mode", isDarkMode);
      });

      /********** AI ASSIST & DEBUG **********/
      document.getElementById("aiAssist").addEventListener("click", async () => {
        if (!editor || !modelLoaded) {
          alert("Model not loaded yet. Please wait...");
          return;
        }
        const userCode = editor.getValue();
        console.log("Requesting AI assist from transformers.js...");
        try {
          const prompt = "Improve this code snippet:\n\n" + userCode + "\n\nImproved version:\n";
          const result = await textGenPipeline(prompt, { max_new_tokens: 60 });
          const suggestion = result[0]?.generated_text?.replace(prompt, "") || "";
          editor.executeEdits(null, [{
            range: editor.getSelection(),
            text: "\n/* AI Assist Suggestion */\n" + suggestion,
            forceMoveMarkers: true
          }]);
          console.log("AI assist inserted.");
        } catch (err) {
          console.error("AI assist error:", err);
          alert("Error in AI Assist. Check console for details.");
        }
      });

      document.getElementById("aiDebug").addEventListener("click", async () => {
        if (!editor || !modelLoaded) {
          alert("Model not loaded yet. Please wait...");
          return;
        }
        const code = editor.getValue();
        console.log("Requesting AI debug from transformers.js...");
        try {
          const prompt = "Analyze the following code for potential bugs and improvements:\n\n" + code + "\n\nAnalysis:\n";
          const result = await textGenPipeline(prompt, { max_new_tokens: 60 });
          const analysis = result[0]?.generated_text?.replace(prompt, "") || "";
          alert("AI Debug Analysis:\n" + analysis);
        } catch (err) {
          console.error("AI debug error:", err);
          alert("Error in AI Debug. Check console for details.");
        }
      });

      /********** GITHUB SYNC (PLACEHOLDER) **********/
      document.getElementById("githubSync").addEventListener("click", async () => {
        const choice = prompt("Type 'load' to fetch from GitHub, 'save' to push to GitHub:");
        if (!choice) return;
        const token = prompt("Enter your GitHub Personal Access Token:");
        if (!token) {
          alert("No token provided.");
          return;
        }
        const repo = prompt("Enter 'owner/repo' to sync with (e.g. 'username/test-repo'):");
        if (choice.toLowerCase() === "load") {
          const path = prompt("Enter the file path in the repo (e.g. 'index.html'):");
          await loadFromGitHub(token, repo, path);
        } else if (choice.toLowerCase() === "save") {
          const path = prompt("Enter the file path in the repo to save to (e.g. 'index.html'):");
          await saveToGitHub(token, repo, path, models.html.getValue());
        } else {
          alert("Invalid choice. Must be 'load' or 'save'.");
        }
      });

      async function loadFromGitHub(token, repo, path) {
        try {
          const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`;
          const resp = await fetch(apiUrl, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!resp.ok) {
            throw new Error(`GitHub fetch error: ${resp.status} ${resp.statusText}`);
          }
          const data = await resp.json();
          const content = atob(data.content);
          models.html.setValue(content);
          alert(`Loaded file from GitHub: ${repo}/${path}`);
        } catch (err) {
          console.error(err);
          alert("Error loading from GitHub. Check console.");
        }
      }

      async function saveToGitHub(token, repo, path, fileContent) {
        try {
          const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`;
          let sha = null;
          const checkResp = await fetch(apiUrl, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (checkResp.ok) {
            const checkData = await checkResp.json();
            sha = checkData.sha || null;
          }
          const newResp = await fetch(apiUrl, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: "Update file via web editor",
              content: btoa(fileContent),
              sha: sha
            })
          });
          if (!newResp.ok) {
            throw new Error(`GitHub save error: ${newResp.status} ${newResp.statusText}`);
          }
          alert(`Saved file to GitHub: ${repo}/${path}`);
        } catch (err) {
          console.error(err);
          alert("Error saving to GitHub. Check console.");
        }
      }

      /********** MOBILE VIEW TOGGLE & DEVICE SIZE **********/
      const toggleMobileBtn = document.getElementById("toggleMobile");
      const deviceSizeSelect = document.getElementById("deviceSize");
      toggleMobileBtn.addEventListener("click", () => {
        const previewContainer = document.getElementById("previewContainer");
        previewContainer.classList.toggle("mobile-view");
        if (previewContainer.classList.contains("mobile-view")) {
          const selectedWidth = deviceSizeSelect.value;
          previewContainer.style.width = selectedWidth + "px";
        } else {
          previewContainer.style.width = "";
        }
      });
      // Also update width when device size selection changes (if in mobile view)
      deviceSizeSelect.addEventListener("change", () => {
        const previewContainer = document.getElementById("previewContainer");
        if (previewContainer.classList.contains("mobile-view")) {
          previewContainer.style.width = deviceSizeSelect.value + "px";
        }
      });

      /********** EXPORT PROJECT (ZIP) **********/
      document.getElementById("exportProject").addEventListener("click", () => {
        const zip = new JSZip();
        zip.file("index.html", models.html.getValue());
        zip.file("styles.css", models.css.getValue());
        zip.file("script.js", models.js.getValue());
        zip.generateAsync({ type: "blob" }).then((content) => {
          const link = document.createElement("a");
          link.href = URL.createObjectURL(content);
          link.download = "project.zip";
          link.click();
        });
      });

      /********** COOKIE MODAL **********/
      document.getElementById("manageCookies").addEventListener("click", () => {
        const cookieModal = document.getElementById("cookieModal");
        const cookieText = document.getElementById("cookieText");
        cookieText.value = document.cookie;
        cookieModal.style.display = "block";
      });
      document.getElementById("closeCookieModal").addEventListener("click", () => {
        document.getElementById("cookieModal").style.display = "none";
      });
      document.getElementById("clearAllCookies").addEventListener("click", () => {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i];
          const eqPos = cookie.indexOf("=");
          const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
          document.cookie = name + "=;expires=" + new Date(0).toUTCString() + ";path=/";
        }
        alert("All cookies cleared.");
        document.getElementById("cookieText").value = "";
      });
      document.getElementById("saveCookies").addEventListener("click", () => {
        alert("Cookie editing not implemented. You can clear cookies instead.");
      });

      /********** TOGGLE & RESIZE CONSOLE **********/
      const consolePanel = document.getElementById("consolePanel");
      const consoleResizer = document.getElementById("consoleResizer");
      document.getElementById("toggleConsole").addEventListener("click", () => {
        consolePanel.style.display = (consolePanel.style.display === "none" || !consolePanel.style.display)
          ? "block" : "none";
      });
      let isConsoleResizing = false;
      consoleResizer.addEventListener("mousedown", (e) => {
        isConsoleResizing = true;
        e.preventDefault();
      });
      document.addEventListener("mousemove", (e) => {
        if (!isConsoleResizing) return;
        // Adjust console panel height based on mouse Y position from bottom
        const newHeight = window.innerHeight - e.clientY;
        if (newHeight > 50 && newHeight < 500) {
          consolePanel.style.height = newHeight + "px";
        }
      });
      document.addEventListener("mouseup", () => {
        isConsoleResizing = false;
      });
      
      /********** OVERRIDE CONSOLE (Capture logs) **********/
      (function overrideConsole() {
        const origLog = console.log;
        console.log = function(...args) {
          origLog.apply(console, args);
          const output = document.getElementById("consoleOutput");
          args.forEach((arg) => {
            const p = document.createElement("p");
            p.textContent = (typeof arg === "object") ? JSON.stringify(arg) : arg;
            output.appendChild(p);
          });
        };
      })();

      /********** LINTING PLACEHOLDER **********/
      let lintTimeout;
      function runLinting() {
        const htmlCode = models.html.getValue();
        const htmlResults = (typeof HTMLHint !== "undefined" && HTMLHint.verify)
          ? HTMLHint.verify(htmlCode) : [];
        if (htmlResults.length) {
          console.log("HTMLHint warnings:");
          htmlResults.forEach(issue => console.log(issue.message));
        }
        const cssCode = models.css.getValue();
        if (cssCode.includes("!important")) {
          console.log("CSS Lint: Avoid using !important for better maintainability.");
        }
        console.log("Running minimal lint on JS (placeholder)...");
      }

      /********** INDEXEDDB (Auto Save) **********/
      let db;
      const openReq = window.indexedDB.open("CodeEditorDB", 5);
      openReq.onerror = e => console.error("IndexedDB error:", e);
      openReq.onupgradeneeded = e => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("projects")) {
          db.createObjectStore("projects", { keyPath: "id" });
        }
      };
      openReq.onsuccess = e => {
        db = e.target.result;
        console.log("IndexedDB initialized.");
        loadFromDB();
      };
      function loadFromDB() {
        if (!db) return;
        const tx = db.transaction(["projects"], "readonly");
        const store = tx.objectStore("projects");
        const req = store.get("default");
        req.onsuccess = evt => {
          const project = evt.target.result;
          if (project) {
            models.html.setValue(project.html);
            models.css.setValue(project.css);
            models.js.setValue(project.js);
            if (autoRunCheckbox.checked) {
              updatePreview();
            }
            console.log("Project loaded from IndexedDB.");
          }
        };
      }
      function saveToDB() {
        if (!db) return;
        const tx = db.transaction(["projects"], "readwrite");
        const store = tx.objectStore("projects");
        const project = {
          id: "default",
          html: models.html.getValue(),
          css: models.css.getValue(),
          js: models.js.getValue()
        };
        store.put(project).onsuccess = () => console.log("Project saved to IndexedDB.");
      }
      setInterval(saveToDB, 30000);

      /********** KEYBOARD SHORTCUTS (CTRL/CMD + S) **********/
      document.addEventListener("keydown", e => {
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          saveToDB();
          alert("Project saved locally.");
        }
      });

      /********** RESIZER DRAG LOGIC (Editor/Preview) **********/
      const resizer = document.getElementById("resizer");
      const editorContainer = document.getElementById("editorContainer");
      const mainContainer = document.getElementById("mainContainer");
      let isDragging = false;
      resizer.addEventListener("mousedown", e => {
        isDragging = true;
        document.body.style.userSelect = "none";
      });
      document.addEventListener("mousemove", e => {
        if (!isDragging) return;
        const offsetLeft = mainContainer.offsetLeft;
        const newWidth = e.clientX - offsetLeft;
        const minWidth = 200;
        const maxWidth = mainContainer.clientWidth - 100;
        if (newWidth > minWidth && newWidth < maxWidth) {
          editorContainer.style.width = newWidth + "px";
        }
      });
      document.addEventListener("mouseup", e => {
        isDragging = false;
        document.body.style.userSelect = "";
      });
    });
  </script>
</body>
</html>
